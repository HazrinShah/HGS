<?php
session_start();

// Check if user is logged in
if (!isset($_SESSION['hikerID'])) {
    header("Location: HLogin.html");
    exit;
}

$hikerID = $_SESSION['hikerID'];

// Database connection
include '../shared/db_connection.php';

// Fetch completed bookings for rating (excluding already rated ones)
$completedBookingsQuery = "SELECT b.*, g.username as guiderName, g.price as guiderPrice, g.phone_number as guiderPhone, 
                         g.profile_picture as guiderPicture, g.email as guiderEmail, g.experience as guiderExperience,
                         m.name as mountainName, m.picture as mountainPicture,
                         r.rating as existingRating, r.comment as existingComment
                         FROM booking b 
                         JOIN guider g ON b.guiderID = g.guiderID 
                         JOIN mountain m ON b.mountainID = m.mountainID 
                         LEFT JOIN review r ON b.bookingID = r.bookingID AND r.hikerID = b.hikerID
                         WHERE b.hikerID = ? AND b.status = 'completed'
                         ORDER BY b.endDate DESC";

$stmt = $conn->prepare($completedBookingsQuery);
$stmt->bind_param("i", $hikerID);
$stmt->execute();
$result = $stmt->get_result();
$completedBookings = $result->fetch_all(MYSQLI_ASSOC);
$stmt->close();

// Handle rating submission
if ($_SERVER["REQUEST_METHOD"] == "POST" && isset($_POST['submit_rating'])) {
    $bookingID = intval($_POST['bookingID']);
    $rating = intval($_POST['rating']);
    $comment = trim($_POST['comment']);
    
    // Check if review already exists
    $checkQuery = "SELECT reviewID FROM review WHERE bookingID = ? AND hikerID = ?";
    $checkStmt = $conn->prepare($checkQuery);
    $checkStmt->bind_param("ii", $bookingID, $hikerID);
    $checkStmt->execute();
    $existingReview = $checkStmt->get_result()->fetch_assoc();
    $checkStmt->close();
    
    if ($existingReview) {
        // Update existing review
        $updateQuery = "UPDATE review SET rating = ?, comment = ?, updatedAt = NOW() WHERE bookingID = ? AND hikerID = ?";
        $updateStmt = $conn->prepare($updateQuery);
        $updateStmt->bind_param("isii", $rating, $comment, $bookingID, $hikerID);
        $updateStmt->execute();
        $updateStmt->close();
        $success_message = "Review updated successfully!";
    } else {
        // Insert new review
        $insertQuery = "INSERT INTO review (bookingID, hikerID, guiderID, rating, comment, createdAt) VALUES (?, ?, (SELECT guiderID FROM booking WHERE bookingID = ?), ?, ?, NOW())";
        $insertStmt = $conn->prepare($insertQuery);
        $insertStmt->bind_param("iiisi", $bookingID, $hikerID, $bookingID, $rating, $comment);
        $insertStmt->execute();
        $insertStmt->close();
        $success_message = "Thank you for your review!";
    }
    
    // Refresh the page to show updated data
    header("Location: HRateReview.php");
    exit;
}
?>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Rate and Review – Hiking Guidance System</title>
  <!-- Bootstrap & FontAwesome -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/all.min.css" />
  <link rel="stylesheet" href="../css/style.css" />
  <style>
    /* Enhanced Color Scheme */
    :root {
      --primary: #1e40af;
      --primary-light: #3b82f6;
      --primary-dark: #1e3a8a;
      --accent: #f59e0b;
      --accent-light: #fbbf24;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --soft-bg: #f8fafc;
      --card-white: #ffffff;
      --text-primary: #1f2937;
      --text-secondary: #6b7280;
      --border-light: #e5e7eb;
    }
    
    body {
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      font-family: "Montserrat", sans-serif;
      min-height: 100vh;
    }
    
    .navbar {
      background: linear-gradient(135deg, var(--primary-dark), var(--primary)) !important;
      box-shadow: 0 4px 20px rgba(30, 64, 175, 0.3);
    }
    
    .logo {
      width: 45px;
      border-radius: 50%;
    }
    
    .main-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem 1rem;
    }
    
    .page-header {
      text-align: center;
      margin-bottom: 3rem;
    }
    
    .page-title {
      font-size: 2.5rem;
      font-weight: 800;
      color: var(--text-primary);
      margin-bottom: 0.5rem;
    }
    
    .page-subtitle {
      font-size: 1.1rem;
      color: var(--text-secondary);
      max-width: 600px;
      margin: 0 auto;
    }
    
    .booking-card {
      background: var(--card-white);
      border-radius: 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      margin-bottom: 2rem;
      overflow: hidden;
      transition: all 0.3s ease;
      border: 1px solid var(--border-light);
    }
    
    .booking-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 16px 48px rgba(0, 0, 0, 0.15);
    }
    
    .card-header {
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      color: white;
      padding: 1.5rem;
      position: relative;
    }
    
    .trip-status {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: var(--success);
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
    }
    
    .mountain-info {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    
    .mountain-image {
      width: 80px;
      height: 80px;
      border-radius: 12px;
      object-fit: cover;
      border: 3px solid rgba(255, 255, 255, 0.3);
    }
    
    .mountain-details h3 {
      font-size: 1.5rem;
      font-weight: 700;
      margin: 0;
    }
    
    .trip-dates {
      font-size: 0.95rem;
      opacity: 0.9;
      margin-top: 0.25rem;
    }
    
    .card-body {
      padding: 2rem;
    }
    
    .guider-section {
      display: flex;
      align-items: center;
      gap: 1.5rem;
      margin-bottom: 1.5rem;
    }
    
    .guider-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      object-fit: cover;
      border: 4px solid var(--border-light);
    }
    
    .guider-info h4 {
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--text-primary);
      margin: 0 0 0.5rem 0;
    }
    
    .guider-experience {
      color: var(--text-secondary);
      font-size: 0.95rem;
      margin-bottom: 0.25rem;
    }
    
    .guider-price {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--primary);
    }
    
    .rating-section {
      background: var(--soft-bg);
      border-radius: 12px;
      padding: 1.5rem;
      margin-top: 1rem;
    }
    
    .rating-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 1rem;
    }
    
    .star-rating {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    
    .star {
      font-size: 2rem;
      color: #e5e7eb;
      cursor: pointer;
      transition: color 0.2s;
    }
    
    .star.active {
      color: var(--accent);
    }
    
    .star:hover {
      color: var(--accent-light);
    }
    
    .rating-input {
      display: none;
    }
    
    .comment-textarea {
      border: 2px solid var(--border-light);
      border-radius: 12px;
      padding: 1rem;
      font-size: 0.95rem;
      resize: vertical;
      min-height: 100px;
      transition: border-color 0.2s;
    }
    
    .comment-textarea:focus {
      border-color: var(--primary);
      outline: none;
      box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1);
    }
    
    .submit-btn {
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      border: none;
      border-radius: 12px;
      padding: 0.75rem 2rem;
      color: white;
      font-weight: 600;
      font-size: 1rem;
      transition: all 0.2s;
      margin-top: 1rem;
    }
    
    .submit-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(30, 64, 175, 0.3);
    }
    
    .existing-rating {
      background: var(--success);
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-size: 0.9rem;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .empty-state {
      text-align: center;
      padding: 4rem 2rem;
      background: var(--card-white);
      border-radius: 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }
    
    .empty-state-icon {
      font-size: 4rem;
      color: var(--text-secondary);
      margin-bottom: 1.5rem;
    }
    
    .empty-state h3 {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 1rem;
    }
    
    .empty-state p {
      color: var(--text-secondary);
      font-size: 1.1rem;
      margin-bottom: 2rem;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      border: none;
      border-radius: 12px;
      padding: 0.75rem 2rem;
      font-weight: 600;
    }
    
    .alert {
      border-radius: 12px;
      border: none;
      margin-bottom: 2rem;
    }
    
    @media (max-width: 768px) {
      .main-container {
        padding: 1rem 0.5rem;
      }
      
      .page-title {
        font-size: 2rem;
      }
      
      .guider-section {
        flex-direction: column;
        text-align: center;
      }
      
      .mountain-info {
        flex-direction: column;
        text-align: center;
      }
      
      .card-body {
        padding: 1.5rem;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header>
    <nav class="navbar">
      <div class="container d-flex align-items-center justify-content-between">
        <button class="navbar-toggler" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasNavbar">
          <span class="navbar-toggler-icon"></span>
        </button>
        <h1 class="navbar-title text-white mx-auto">HIKING GUIDANCE SYSTEM</h1>
        <a class="navbar-brand" href="../index.html">
          <img src="../img/logo.png" class="img-fluid logo" alt="HGS Logo">
        </a>
      </div>
      <div class="offcanvas offcanvas-start" id="offcanvasNavbar">
        <div class="offcanvas-header">
          <h5 class="offcanvas-title">Menu</h5>
          <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="offcanvas-body">
          <ul class="navbar-nav">
            <li class="nav-item"><a class="nav-link" href="HHomePage.php">Home</a></li>
            <li class="nav-item"><a class="nav-link" href="HProfile.php">Profile</a></li>
            <li class="nav-item"><a class="nav-link" href="HBooking.php">Book Guider</a></li>
            <li class="nav-item"><a class="nav-link" href="HPayment.php">Payment</a></li>
            <li class="nav-item"><a class="nav-link" href="HYourGuider.php">Your Guider</a></li>
            <li class="nav-item"><a class="nav-link active" href="HRateReview.php">Rate and Review</a></li>
            <li class="nav-item"><a class="nav-link" href="HBookingHistory.html">Booking History</a></li>
          </ul>
          <form action="../shared/logout.php" method="POST" class="d-flex justify-content-center mt-5">
            <button type="submit" class="btn btn-danger">Logout</button>
          </form>
        </div>
      </div>
    </nav>
  </header>
  <!-- Rate and Review Section -->
  <main class="py-5">
    <div class="main-container">
      <!-- Page Header -->
      <div class="page-header">
        <h1 class="page-title">
          <i class="fas fa-star me-3" style="color: var(--accent);"></i>
          Rate and Review
        </h1>
        <p class="page-subtitle">
          Share your experience and help other hikers by rating your completed trips
        </p>
      </div>

      <?php if (isset($success_message)): ?>
        <div class="alert alert-success alert-dismissible fade show" role="alert">
          <i class="fas fa-check-circle me-2"></i>
          <?php echo htmlspecialchars($success_message); ?>
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      <?php endif; ?>

      <?php if (empty($completedBookings)): ?>
        <!-- Empty State -->
        <div class="empty-state">
          <div class="empty-state-icon">
            <i class="fas fa-mountain"></i>
          </div>
          <h3>No Completed Trips Yet</h3>
          <p>You haven't completed any hiking trips yet. Once you mark a trip as done, you'll be able to rate and review your guider here.</p>
          <a href="HYourGuider.php" class="btn btn-primary btn-lg">
            <i class="fas fa-calendar-check me-2"></i>View Your Trips
          </a>
        </div>
      <?php else: ?>
        <!-- Completed Bookings -->
        <?php foreach ($completedBookings as $booking): ?>
          <div class="booking-card">
            <!-- Card Header -->
            <div class="card-header">
              <div class="trip-status">
                <i class="fas fa-check-circle me-1"></i>
                Completed
              </div>
              <div class="mountain-info">
                <?php if ($booking['mountainPicture']): ?>
                  <img src="../upload/<?php echo htmlspecialchars($booking['mountainPicture']); ?>" 
                       alt="<?php echo htmlspecialchars($booking['mountainName']); ?>" 
                       class="mountain-image">
                <?php else: ?>
                  <img src="../img/mountain-default.jpg" 
                       alt="Default Mountain" 
                       class="mountain-image">
                <?php endif; ?>
                <div class="mountain-details">
                  <h3><?php echo htmlspecialchars($booking['mountainName']); ?></h3>
                  <div class="trip-dates">
                    <i class="fas fa-calendar-alt me-1"></i>
                    <?php echo date('M j, Y', strtotime($booking['startDate'])); ?> - 
                    <?php echo date('M j, Y', strtotime($booking['endDate'])); ?>
                  </div>
                </div>
              </div>
            </div>

            <!-- Card Body -->
            <div class="card-body">
              <!-- Guider Information -->
              <div class="guider-section">
                <?php if ($booking['guiderPicture']): ?>
                  <img src="../uploads/<?php echo htmlspecialchars($booking['guiderPicture']); ?>" 
                       alt="<?php echo htmlspecialchars($booking['guiderName']); ?>" 
                       class="guider-avatar">
                <?php else: ?>
                  <div class="guider-avatar" style="background: var(--primary); display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem;">
                    <i class="fas fa-user"></i>
                  </div>
                <?php endif; ?>
                <div class="guider-info">
                  <h4><?php echo htmlspecialchars($booking['guiderName']); ?></h4>
                  <div class="guider-experience">
                    <i class="fas fa-award me-1"></i>
                    <?php echo htmlspecialchars($booking['guiderExperience']); ?> years experience
                  </div>
                  <div class="guider-price">
                    <i class="fas fa-dollar-sign me-1"></i>
                    RM <?php echo number_format($booking['price'], 2); ?>
                  </div>
                </div>
              </div>

              <!-- Rating Section -->
              <div class="rating-section">
                <?php if ($booking['existingRating']): ?>
                  <!-- Existing Rating Display -->
                  <div class="rating-title">
                    <i class="fas fa-star me-2" style="color: var(--accent);"></i>
                    Your Rating
                  </div>
                  <div class="existing-rating">
                    <i class="fas fa-star me-1"></i>
                    <?php echo $booking['existingRating']; ?>/5
                    <?php if ($booking['existingComment']): ?>
                      <span class="ms-2">- "<?php echo htmlspecialchars(substr($booking['existingComment'], 0, 50)); ?><?php echo strlen($booking['existingComment']) > 50 ? '...' : ''; ?>"</span>
                    <?php endif; ?>
                  </div>
                  <button class="btn btn-outline-primary mt-2" onclick="editRating(<?php echo $booking['bookingID']; ?>)">
                    <i class="fas fa-edit me-1"></i>Edit Rating
                  </button>
                <?php else: ?>
                  <!-- Rating Form -->
                  <div class="rating-title">
                    <i class="fas fa-star me-2" style="color: var(--accent);"></i>
                    Rate Your Experience
                  </div>
                  <form method="POST" action="">
                    <input type="hidden" name="bookingID" value="<?php echo $booking['bookingID']; ?>">
                    <input type="hidden" name="submit_rating" value="1">
                    
                    <!-- Star Rating -->
                    <div class="star-rating" data-booking="<?php echo $booking['bookingID']; ?>">
                      <span class="star" data-rating="1">★</span>
                      <span class="star" data-rating="2">★</span>
                      <span class="star" data-rating="3">★</span>
                      <span class="star" data-rating="4">★</span>
                      <span class="star" data-rating="5">★</span>
                    </div>
                    <input type="hidden" name="rating" id="rating_<?php echo $booking['bookingID']; ?>" value="0" required>
                    
                    <!-- Comment -->
                    <textarea name="comment" class="form-control comment-textarea" 
                              placeholder="Share your experience with this guider... (optional)"></textarea>
                    
                    <!-- Submit Button -->
                    <button type="submit" class="submit-btn">
                      <i class="fas fa-paper-plane me-2"></i>Submit Review
                    </button>
                  </form>
                <?php endif; ?>
              </div>
            </div>
          </div>
        <?php endforeach; ?>
      <?php endif; ?>
    </div>

  </main>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Star rating functionality
    document.addEventListener('DOMContentLoaded', function() {
      const starRatings = document.querySelectorAll('.star-rating');
      
      starRatings.forEach(function(ratingContainer) {
        const stars = ratingContainer.querySelectorAll('.star');
        const bookingID = ratingContainer.getAttribute('data-booking');
        const ratingInput = document.getElementById('rating_' + bookingID);
        
        stars.forEach(function(star, index) {
          star.addEventListener('click', function() {
            const rating = index + 1;
            ratingInput.value = rating;
            
            // Update star display
            stars.forEach(function(s, i) {
              if (i < rating) {
                s.classList.add('active');
              } else {
                s.classList.remove('active');
              }
            });
          });
          
          star.addEventListener('mouseenter', function() {
            const rating = index + 1;
            stars.forEach(function(s, i) {
              if (i < rating) {
                s.style.color = 'var(--accent-light)';
              } else {
                s.style.color = '#e5e7eb';
              }
            });
          });
        });
        
        ratingContainer.addEventListener('mouseleave', function() {
          const currentRating = parseInt(ratingInput.value) || 0;
          stars.forEach(function(s, i) {
            if (i < currentRating) {
              s.style.color = 'var(--accent)';
            } else {
              s.style.color = '#e5e7eb';
            }
          });
        });
      });
    });
    
    // Edit rating functionality
    function editRating(bookingID) {
      // This would open a modal or inline form for editing
      // For now, we'll just scroll to the rating section
      const ratingSection = document.querySelector(`[data-booking="${bookingID}"]`).closest('.rating-section');
      ratingSection.scrollIntoView({ behavior: 'smooth' });
      
      // You could implement a more sophisticated edit modal here
      alert('Edit functionality can be implemented here. For now, you can submit a new rating to update your review.');
    }
    
    // Form validation
    document.addEventListener('submit', function(e) {
      if (e.target.querySelector('input[name="submit_rating"]')) {
        const ratingInput = e.target.querySelector('input[name="rating"]');
        if (!ratingInput.value || ratingInput.value === '0') {
          e.preventDefault();
          alert('Please select a rating before submitting.');
          return false;
        }
      }
    });
  </script>
</body>
</html> 